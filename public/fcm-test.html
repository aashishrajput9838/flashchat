<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FCM Test Page</h1>
        
        <div class="section">
            <h2>Environment Check</h2>
            <div id="env-check"></div>
        </div>
        
        <div class="section">
            <h2>Service Worker Status</h2>
            <div id="sw-status"></div>
            <button id="check-sw">Check Service Worker</button>
        </div>
        
        <div class="section">
            <h2>Notification Permission</h2>
            <div id="permission-status"></div>
            <button id="request-permission">Request Permission</button>
        </div>
        
        <div class="section">
            <h2>FCM Token</h2>
            <div id="token-status"></div>
            <button id="get-token">Get FCM Token</button>
            <button id="copy-token">Copy Token</button>
        </div>
        
        <div class="section">
            <h2>Send Test Notification</h2>
            <label for="test-token">FCM Token:</label>
            <input type="text" id="test-token" placeholder="Enter FCM token">
            
            <label for="test-title">Title:</label>
            <input type="text" id="test-title" value="Test Notification" placeholder="Notification title">
            
            <label for="test-body">Body:</label>
            <textarea id="test-body" placeholder="Notification body">This is a test notification from FCM Test Page</textarea>
            
            <label for="test-backend">Backend URL:</label>
            <input type="text" id="test-backend" value="http://localhost:3001" placeholder="Backend URL">
            
            <button id="send-notification">Send Test Notification</button>
        </div>
        
        <div class="section">
            <h2>Debug Output</h2>
            <button id="run-debug">Run Full Debug</button>
            <pre id="debug-output"></pre>
        </div>
    </div>

    <script>
        // Utility functions
        function updateElement(id, content, className = '') {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = content;
                if (className) {
                    element.className = className;
                }
            }
        }
        
        function formatDate(date) {
            return new Date(date).toLocaleString();
        }
        
        // Environment check
        function checkEnvironment() {
            const envInfo = {
                timestamp: new Date().toISOString(),
                browserSupport: {
                    notification: 'Notification' in window,
                    serviceWorker: 'serviceWorker' in navigator,
                    pushManager: 'PushManager' in window
                },
                envVars: {
                    VITE_FCM_VAPID_KEY: !!import.meta.env?.VITE_FCM_VAPID_KEY,
                    VITE_FIREBASE_VAPID_KEY: !!import.meta.env?.VITE_FIREBASE_VAPID_KEY
                }
            };
            
            let html = `<p><strong>Timestamp:</strong> ${formatDate(envInfo.timestamp)}</p>`;
            html += '<p><strong>Browser Support:</strong></p><ul>';
            html += `<li>Notification API: ${envInfo.browserSupport.notification ? '✓' : '✗'}</li>`;
            html += `<li>Service Worker API: ${envInfo.browserSupport.serviceWorker ? '✓' : '✗'}</li>`;
            html += `<li>Push Manager API: ${envInfo.browserSupport.pushManager ? '✓' : '✗'}</li>`;
            html += '</ul>';
            
            html += '<p><strong>Environment Variables:</strong></p><ul>';
            html += `<li>VITE_FCM_VAPID_KEY: ${envInfo.envVars.VITE_FCM_VAPID_KEY ? 'SET' : 'NOT SET'}</li>`;
            html += `<li>VITE_FIREBASE_VAPID_KEY: ${envInfo.envVars.VITE_FIREBASE_VAPID_KEY ? 'SET' : 'NOT SET'}</li>`;
            html += '</ul>';
            
            updateElement('env-check', html, 
                envInfo.browserSupport.notification && 
                envInfo.browserSupport.serviceWorker && 
                envInfo.browserSupport.pushManager ? 'success' : 'warning');
        }
        
        // Service worker check
        async function checkServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                updateElement('sw-status', 'Service Worker API not available', 'error');
                return;
            }
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length === 0) {
                    updateElement('sw-status', 'No service workers registered', 'warning');
                    return;
                }
                
                let html = '<p>Registered service workers:</p><ul>';
                registrations.forEach(reg => {
                    const state = reg.installing ? 'installing' : 
                                 reg.waiting ? 'waiting' : 
                                 reg.active ? 'active' : 'unknown';
                    html += `<li>Scope: ${reg.scope}<br>State: ${state}</li>`;
                });
                html += '</ul>';
                
                updateElement('sw-status', html, 'success');
            } catch (error) {
                updateElement('sw-status', `Error: ${error.message}`, 'error');
            }
        }
        
        // Notification permission check
        function checkPermission() {
            if (!('Notification' in window)) {
                updateElement('permission-status', 'Notification API not supported', 'error');
                return;
            }
            
            const permission = Notification.permission;
            let className = '';
            let message = '';
            
            switch (permission) {
                case 'granted':
                    className = 'success';
                    message = 'Permission granted';
                    break;
                case 'denied':
                    className = 'error';
                    message = 'Permission denied';
                    break;
                case 'default':
                    className = 'warning';
                    message = 'Permission not requested yet';
                    break;
            }
            
            updateElement('permission-status', message, className);
        }
        
        // Request notification permission
        async function requestPermission() {
            if (!('Notification' in window)) {
                updateElement('permission-status', 'Notification API not supported', 'error');
                return;
            }
            
            try {
                const permission = await Notification.requestPermission();
                checkPermission();
            } catch (error) {
                updateElement('permission-status', `Error: ${error.message}`, 'error');
            }
        }
        
        // Get FCM token
        async function getFcmToken() {
            if (typeof window.getFcmToken === 'function') {
                try {
                    updateElement('token-status', 'Requesting FCM token...', 'warning');
                    const token = await window.getFcmToken();
                    if (token) {
                        updateElement('token-status', 
                            `<p>Token obtained successfully!</p>
                             <p><strong>Token:</strong> ${token.substring(0, 50)}...</p>
                             <p><em>Full token available in console and window.fcmToken</em></p>`, 
                            'success');
                        document.getElementById('test-token').value = token;
                    } else {
                        updateElement('token-status', 'Failed to obtain FCM token. Check console for details.', 'error');
                    }
                } catch (error) {
                    updateElement('token-status', `Error: ${error.message}`, 'error');
                }
            } else {
                updateElement('token-status', 'FCM functions not available. Make sure the app is loaded.', 'error');
            }
        }
        
        // Copy token to clipboard
        function copyToken() {
            const token = window.fcmToken;
            if (token) {
                navigator.clipboard.writeText(token).then(() => {
                    alert('Token copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy token: ', err);
                    alert('Failed to copy token. Check console for details.');
                });
            } else {
                alert('No token available to copy.');
            }
        }
        
        // Send test notification
        async function sendTestNotification() {
            const token = document.getElementById('test-token').value;
            const title = document.getElementById('test-title').value;
            const body = document.getElementById('test-body').value;
            const backendUrl = document.getElementById('test-backend').value;
            
            if (!token) {
                alert('Please enter an FCM token');
                return;
            }
            
            if (!title) {
                alert('Please enter a title');
                return;
            }
            
            try {
                const response = await fetch(`${backendUrl}/api/send-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        title: title,
                        body: body,
                        icon: '/icon-192x192.png'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Test notification sent successfully!');
                } else {
                    alert(`Failed to send notification: ${result.error}`);
                }
            } catch (error) {
                console.error('Error sending test notification:', error);
                alert(`Error sending test notification: ${error.message}`);
            }
        }
        
        // Run full debug
        async function runFullDebug() {
            updateElement('debug-output', 'Running debug...\n');
            
            try {
                // Try to import and run our debug utility
                if (typeof window.runFcmDebug === 'function') {
                    const results = await window.runFcmDebug();
                    updateElement('debug-output', JSON.stringify(results, null, 2));
                } else {
                    // Fallback debug
                    const debugInfo = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        onLine: navigator.onLine,
                        cookieEnabled: navigator.cookieEnabled
                    };
                    updateElement('debug-output', JSON.stringify(debugInfo, null, 2));
                }
            } catch (error) {
                updateElement('debug-output', `Debug error: ${error.message}\n${error.stack}`);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set up event listeners
            document.getElementById('check-sw').addEventListener('click', checkServiceWorker);
            document.getElementById('request-permission').addEventListener('click', requestPermission);
            document.getElementById('get-token').addEventListener('click', getFcmToken);
            document.getElementById('copy-token').addEventListener('click', copyToken);
            document.getElementById('send-notification').addEventListener('click', sendTestNotification);
            document.getElementById('run-debug').addEventListener('click', runFullDebug);
            
            // Run initial checks
            checkEnvironment();
            checkServiceWorker();
            checkPermission();
            
            // Check if FCM functions are available
            if (typeof window.getFcmToken !== 'function') {
                console.log('FCM functions not yet available. They will be available after the app loads.');
            }
        });
    </script>
</body>
</html>